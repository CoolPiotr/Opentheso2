<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="javascript/go.js"></script>
        <script type="text/javascript" src="javascript/jquery-3.5.1.min.js"></script>

        <script type="text/javascript">
            var response;
            var thesSelected;
            var lang;
            var conceptIdSelected;

            function init() {
                if (window.goSamples)
                    goSamples();

                var $ = go.GraphObject.make;

                myDiagram = $(go.Diagram, "myDiagramDiv", {
                    initialContentAlignment: go.Spot.Center,
                    "toolManager.hoverDelay": 100,  // 100 milliseconds instead of the default 850
                    allowCopy: false,
                    layout: $(go.TreeLayout,
                        { angle: 90, nodeSpacing: 10, layerSpacing: 40, layerStyle: go.TreeLayout.LayerUniform }),
                    allowSelect: false, 
                    "commandHandler.copiesTree": true,  // for the copy command
                    "commandHandler.deletesTree": true, // for the delete command
                    "draggingTool.dragsTree": true,  // dragging for both move and copy
                    "undoManager.isEnabled": true
                });

                // define the Node template for non-terminal nodes
                myDiagram.nodeTemplate =
                    $(go.Node, "Spot", {
                        selectionObjectName: "PANEL",
                        isShadowed: false,
                        isTreeLeaf: false,
                        isTreeExpanded: false,
                    },
                    
                    $(go.Panel, 
                        "Auto",
                        { name: "PANEL" },
                        $(go.Shape, "RoundedRectangle",
                            {fill: "#43B572", stroke: "#43B572"}),
                        $(go.TextBlock,
                            { font: "11pt sans-serif", margin: 5 },
                            new go.Binding("text", "key"))
                    ),

                    $("TreeExpanderButton", {
                        name: 'TREEBUTTON',
                        width: 20, height: 20,
                        alignment: go.Spot.TopRight,
                        alignmentFocus: go.Spot.Center,
                        click: function (e, obj) {  // OBJ is the Button
                            var node = obj.part;  // get the Node containing this Button
                            if (node === null)
                                return;
                            e.handled = true;
                            expandNode(node);
                        }
                    })
                );
        
                myDiagram.linkTemplate = $(go.Link,  // the whole link panel
                    { routing: go.Link.Orthogonal, corner: 5, selectable: false },
                    $(go.Shape, { strokeWidth: 3, stroke: '#f47b2a' }));  // the gray link shape

                var request = new XMLHttpRequest();
                request.open('GET', 'http://localhost:8080/opentheso2/api/graph/firstElement', true);
                request.onload = function () {
                    response = JSON.parse(this.response);
                    if (request.status === 200) {

                        thesSelected = response.idTheso;
                        lang = response.lang;
                        conceptIdSelected = response.name;

                        myDiagram.model = new go.TreeModel([
                            {key: response.name, color: $(go.Brush, "Linear", {0: "#EF9EFA", 1: "#A570AD"})}
                        ]);
                    } else {
                        console.log('error')
                    }
                };

                request.send();

            }

            function expandNode(node) {
                conceptIdSelected = node.key;
                node.diagram.startTransaction("CollapseExpandTree");

                if (!node.data.everExpanded) {
                    node.diagram.model.setDataProperty(node.data, "everExpanded", true);
                    createSubTree(node.data);
                }

                if (node.isTreeExpanded) {
                    node.diagram.commandHandler.collapseTree(node);
                } else {
                    node.diagram.commandHandler.expandTree(node);
                }

                node.diagram.commitTransaction("CollapseExpandTree");
                myDiagram.zoomToFit();
            }

            function createSubTree(parentdata) {

                var parent = myDiagram.findNodeForData(parentdata);

               $(document).ready(function () {
                    $.ajax({
                        url: 'http://localhost:8080/opentheso2/api/graph/' + thesSelected + '/' + conceptIdSelected + '/' + lang
                    }).then(function (data) {
                        response = data;
                        if (Array.isArray(response)) {

                            for (var i = 0; i < response.length; i++) {
                                var color = "#FEC901";
                                if (response[i].isHaveChildren === "true") {
                                    color = "#A570AD";
                                }
                                
                                var childdata = {
                                    key: response[i].name, 
                                    parent: parentdata.key, 
                                    color: color};
                                
                                myDiagram.model.addNodeData(childdata);
                                var child = myDiagram.findNodeForData(childdata);
                                if (response[i].isHaveChildren === "false") {
                                    child.findObject('TREEBUTTON').visible = false;
                                } else {
                                    child.findObject('TREEBUTTON').extensible = false;
                                }
                                child.location = parent.location;
                            }
                        }
                        conceptIdSelected = null;
                    });
                });
            }
        </script>
    </head>
    <body onload="init()">
        <div id="sample">
            <div id="myDiagramDiv" style="border: 1px solid black; width:100%; height:600px"/>
        </div>
    </body>
</html>